val String APIKey = "INSERT-API-KEY"
val String PodID = "INSERT-POD-ID"

/*** Read Sensibo State ***/

rule "Read Sensibo State"

  when
    System started
  then

  try {
    var String PodStatus = executeCommandLine('curl -sSH "Accept: application/json"     "https://home.sensibo.com/api/v2/pods/' + PodID + '/acStates?apiKey=' + APIKey + '&limit=1&fields=acState"', 5000)

    if (PodStatus.contains('"status": "success"')) {
      val String PodOn = (transform("JSONPATH", "$.result[0].acState.on", PodStatus))
      val String PodMode = (transform("JSONPATH", "$.result[0].acState.mode", PodStatus))
      val Number PodTarget = new Integer(transform("JSONPATH", "$.result[0].acState.targetTemperature", PodStatus))
      val String PodFan = (transform("JSONPATH", "$.result[0].acState.fanLevel", PodStatus))

      if (PodOn == "true")
        { postUpdate(SensiboState, ON) }

      if (PodOn == "false")
        { postUpdate(SensiboState, OFF) }

      postUpdate(SensiboTarget, PodTarget)
      postUpdate(SensiboMode, PodMode)
      postUpdate(SensiboFan, PodFan)

      if (PodStatus.contains('"swing": ')) {
        val String PodSwing = (transform("JSONPATH", "$.result[0].acState.swing", PodStatus))
        postUpdate(SensiboSwing, PodSwing)
      }
    }
    
    else {
      logError("Pod state", "Error reading from Sensibo API")
    }
  }

  catch(Throwable t) {
    logError("Sensibo read state", "Error was caught: {}", t)
  }

end
  

/*** Read Sensibo Measurements ***/

rule "Read Sensibo Measurements"

  when
    System started or
    Time cron "0 0/5 * * * ?"
  then

  try {
    var String PodMeasurements = executeCommandLine('curl -sSH "Accept: application/json"     "https://home.sensibo.com/api/v2/pods/' + PodID + '/measurements?apiKey=' + APIKey + '&fields=temperature,humidity,batteryVoltage"', 5000)

    if (PodMeasurements.contains('"status": "success"')) {
      val Number PodTemperature = new Double(transform("JSONPATH", "$.result[0].temperature", PodMeasurements))
      val Number PodHumidity = new Double(transform("JSONPATH", "$.result[0].humidity", PodMeasurements))

      postUpdate(SensiboTemp, PodTemperature)
      postUpdate(SensiboHumidity, PodHumidity)

      if (!PodMeasurements.contains('"batteryVoltage": null')) {
        val Number PodBattery = new Integer(transform("JSONPATH", "$.result[0].batteryVoltage", PodMeasurements))
        postUpdate(SensiboBattery, PodBattery)
      }
    }

    else {
      logError("Pod measurements", "Error reading from Sensibo API")
    }
  }
  
  catch(Throwable e) {
    logError("Sensibo measurements", "Error was caught: {}", e)
  }

end

/*** Write Sensibo State ***/

rule "Write Sensibo State"

  when
    Item SensiboState changed or
    Item SensiboMode received command or
    Item SensiboFan received command or
    Item SensiboSwing received command or
    Item SensiboTarget received command
  then
  
  try {
    var Boolean PodBoolean

    if (SensiboState.state == ON)
      { PodBoolean = true }
    else
      { PodBoolean = false }

    var String CommandURL = 'https://home.sensibo.com/api/v2/pods/' + PodID + '/acStates?apiKey=' + APIKey

    var String CommandState = '{"acState":{"on":' + PodBoolean + ','
    var String CommandMode = '"mode":"' + SensiboMode.state + '",'
    var String CommandFan = '"fanLevel":"' + SensiboFan.state + '",'
    var String CommandSwing = ""

    if (SensiboSwing.state != "")
      { CommandSwing = '"swing":"' + SensiboSwing.state + '",' }

    var String CommandTemp = '"targetTemperature":' + (SensiboTarget.state as DecimalType).intValue + '}}'
    var String CommandData = CommandState + CommandMode + CommandFan + CommandSwing + CommandTemp

    var String UpdateResult = executeCommandLine('curl@@-sSH@@"Content-Type: application/json"@@-XPOST@@' + CommandURL + '@@-d@@'+ CommandData, 10000)
    logInfo("Update result", UpdateResult)

    if (!UpdateResult.contains('"status": "success"')) {
      logInfo("Pod write", "Error writing to Sensobi API, retrying in 5 seconds")
      Thread::sleep(5000)
      sendCommand(SensiboMode, SensiboMode.state.toString)
    }
  }

  catch(Throwable t) {
    logError("Sensibo write", "Error was caught: {}", t)
  }

end
